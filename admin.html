<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <title>Irra Admin | Manage Orders</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hanuman:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body { background: #f8f9fa; font-family: 'Hanuman', serif; padding: 20px; }
        .card { border-radius: 15px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .status-completed { color: #27ae60; font-weight: bold; }
        .status-failed { color: #e74c3c; font-weight: bold; }
        .btn-action { margin-right: 5px; border-radius: 8px; }

        /* Modal Style */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-icon { font-size: 50px; margin-bottom: 15px; }
        #modalTitle { font-weight: 700; margin-bottom: 10px; color: #2c3e50; }
        #modalBody { color: #7f8c8d; margin-bottom: 20px; }
        .modal-footer { display: flex; justify-content: center; gap: 10px; }
        #modalInput { border-radius: 10px; padding: 12px; margin-bottom: 20px; border: 2px solid #eee; }
        #modalInput:focus { border-color: #3498db; box-shadow: none; outline: none; }
    </style>
</head>
<body>

<!-- Custom Modal Structure -->
<div id="customModal" class="modal-overlay">
    <div class="modal-content animate__animated animate__zoomIn">
        <div id="modalIcon" class="modal-icon"></div>
        <h3 id="modalTitle">á…áŸ†áá„á‡á¾á„</h3>
        <p id="modalBody">ááŸ’á›á¹á˜áŸá¶ášáŸá¶áš...</p>
        <div id="inputContainer" style="display: none;">
            <input type="text" id="modalInput" class="form-control" placeholder="á”á‰áŸ’á…á¼á› Link á“áŸ…á‘á¸á“áŸáŸ‡...">
        </div>
        <div class="modal-footer">
            <button onclick="closeCustomModal()" class="btn btn-light" style="border-radius: 10px;">á”áŸ„áŸ‡á”á„áŸ‹</button>
            <button id="modalConfirmBtn" class="btn btn-primary" style="border-radius: 10px;">á™á›áŸ‹á–áŸ’ášá˜</button>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold"><i class="fas fa-box-open text-primary"></i> á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á€á¶ášá”á‰áŸ’á‡á¶á‘á·á‰</h2>
        <button onclick="fetchOrders()" class="btn btn-dark" style="border-radius: 10px;"><i class="fas fa-sync"></i> Refresh</button>
    </div>

    <div class="card p-3">
        <table class="table table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>á˜áŸ‰áŸ„á„á”á‰áŸ’á‡á¶á‘á·á‰</th>
                    <th>Gmail á—áŸ’á‰áŸ€áœ</th>
                    <th>áˆáŸ’á˜áŸ„áŸ‡ Skin</th>
                    <th>áá˜áŸ’á›áŸƒ</th>
                    <th>áŸáŸ’áá¶á“á—á¶á–</th>
                    <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
                </tr>
            </thead>
            <tbody id="orderList">
                <tr><td colspan="6" class="text-center text-muted">á€áŸ†á–á»á„á‘á¶á‰á™á€á‘á·á“áŸ’á“á“áŸá™...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const API = "http://127.0.0.1:5001/api";

// --- á˜á»áá„á¶ášá”á„áŸ’á á¶á‰á•áŸ’á‘á¶áŸ†á„ Modal (áŸá˜áŸ’ášá¶á”áŸ‹á‡áŸ„á‚á‡áŸá™ á”ášá¶á‡áŸá™ á“á·á„á›á»á”) ---
function showModal({ title, body, icon, showInput, confirmText, color }) {
    return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const inputContainer = document.getElementById('inputContainer');
        const modalInput = document.getElementById('modalInput');
        
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalBody').innerText = body;
        document.getElementById('modalIcon').innerHTML = icon;
        document.getElementById('modalIcon').style.color = color;
        
        confirmBtn.innerText = confirmText || "á™á›áŸ‹á–áŸ’ášá˜";
        
        // á€áŸ†áááŸ‹á–ááŸŒá”áŸŠá¼áá»á„áá¶á˜áŸáŸ’áá¶á“á—á¶á–
        confirmBtn.className = "btn"; // Reset class
        if (color === "#27ae60") confirmBtn.classList.add("btn-success");
        else if (color === "#e74c3c") confirmBtn.classList.add("btn-danger");
        else confirmBtn.classList.add("btn-warning");

        if (showInput) {
            inputContainer.style.display = 'block';
            modalInput.value = '';
            modalInput.style.borderColor = "#eee";
            setTimeout(() => modalInput.focus(), 100);
        } else {
            inputContainer.style.display = 'none';
        }

        modal.style.display = 'flex';

        confirmBtn.onclick = () => {
            const value = showInput ? modalInput.value.trim() : true;
            if (showInput && !value) {
                modalInput.style.borderColor = "red";
                return;
            }
            modal.style.display = 'none';
            resolve(value);
        };
    });
}

function closeCustomModal() {
    document.getElementById('customModal').style.display = 'none';
}

// --- á˜á»áá„á¶ášá‘á¶á‰á™á€á‘á·á“áŸ’á“á“áŸá™á–á¸ Database ---
async function fetchOrders() {
    try {
        const res = await fetch(`${API}/admin/orders`);
        if (!res.ok) throw new Error("á˜á·á“á¢á¶á…á‘á¶á‰á™á€á‘á·á“áŸ’á“á“áŸá™á”á¶á“");
        const orders = await res.json();
        const list = document.getElementById('orderList');
        list.innerHTML = '';

        if (orders.length === 0) {
            list.innerHTML = '<tr><td colspan="6" class="text-center text-muted">á˜á·á“á‘á¶á“áŸ‹á˜á¶á“á€á¶ášá”á‰áŸ’á‡á¶á‘á·á‰á“áŸ…á¡á¾á™</td></tr>';
            return;
        }

        orders.forEach(o => {
            let statusClass = o.status === 'Completed' ? 'status-completed' : (o.status === 'Failed' ? 'status-failed' : 'text-warning');
            list.innerHTML += `
            <tr class="animate__animated animate__fadeIn">
                <td><small class="text-muted">${o.timestamp}</small></td>
                <td><strong>${o.gmail}</strong></td>
                <td><span class="badge bg-dark">${o.skin_name}</span></td>
                <td><span class="text-primary fw-bold">${o.amount}</span></td>
                <td><span class="${statusClass}">${o.status}</span></td>
                <td>
                    <button onclick="sendSuccess('${o.id}', '${o.gmail}')" class="btn btn-sm btn-success btn-action" title="á•áŸ’á‰á¾ File á‡áŸ„á‚á‡áŸá™"><i class="fas fa-check"></i></button>
                    <button onclick="sendFailed('${o.id}', '${o.gmail}')" class="btn btn-sm btn-warning btn-action" title="á•áŸ’á‰á¾áŸá¶ášá”ášá¶á‡áŸá™"><i class="fas fa-times"></i></button>
                    <button onclick="editOrder('${o.id}', '${o.gmail}', '${o.skin_name}', '${o.amount}')" class="btn btn-sm btn-info btn-action" title="á€áŸ‚á”áŸ’ášáŸ‚"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteOrder('${o.id}')" class="btn btn-sm btn-danger btn-action" title="á›á»á”"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
    } catch (err) {
        console.error("Fetch error:", err);
        document.getElementById('orderList').innerHTML = '<tr><td colspan="6" class="text-center text-danger">á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá—áŸ’á‡á¶á”áŸ‹á‘áŸ…á€á¶á“áŸ‹ Backend!</td></tr>';
    }
}

// --- á˜á»áá„á¶ášá•áŸ’á‰á¾áŸá¶ášá‡áŸ„á‚á‡áŸá™ ---
async function sendSuccess(id, gmail) {
    const link = await showModal({
        title: "á•áŸ’á‰á¾ Link á•á›á·áá•á›",
        body: `áŸá¼á˜á”á‰áŸ’á…á¼á› Link áŸá˜áŸ’ášá¶á”áŸ‹á•áŸ’á‰á¾á‘áŸ…á€á¶á“áŸ‹: ${gmail}`,
        icon: '<i class="fas fa-check-circle"></i>',
        showInput: true,
        confirmText: "á•áŸ’á‰á¾ File á‘áŸ…á—áŸ’á‰áŸ€áœ",
        color: "#27ae60"
    });

    if (link) {
        const subject = "á€á¶ášá‘á·á‰ášá”áŸáŸ‹á¢áŸ’á“á€á”á¶á“á‡áŸ„á‚á‡áŸá™ âœ…";
        const msg = `á€á¶ášá‘á·á‰ášá”áŸáŸ‹á¢áŸ’á“á€á”á¶á“á‡áŸ„á‚á‡áŸá™ âœ…\n\náŸá¼á˜á‡á˜áŸ’ášá¶á”á‡á¼á“,\nâ€¢ á€á¶ášá”á‰áŸ’á‡á¶á‘á·á‰ášá”áŸáŸ‹á¢áŸ’á“á€á”á¶á“á”á‰áŸ’á…á”áŸ‹áŠáŸ„á™á‡áŸ„á‚á‡áŸá™áŸá¼á˜ Save File\n\nğŸ”— Link Download: ${link}\n\náŸá¼á˜á¢ášá‚á»ááŠáŸ‚á›á”á¶á“á‚á¶áŸ†á‘áŸ’áš Irra Store!`;
        await postResponse(id, gmail, msg, subject);
    }
}

// --- á˜á»áá„á¶ášá•áŸ’á‰á¾áŸá¶ášá”ášá¶á‡áŸá™ ---
async function sendFailed(id, gmail) {
    const confirmAction = await showModal({
        title: "á”áŠá·áŸáŸá’á€á¶ášá”á‰áŸ’á‡á¶á‘á·á‰",
        body: `áá¾á¢áŸ’á“á€á…áŸ’á”á¶áŸáŸ‹á‘áŸáá¶á“á¹á„á•áŸ’á‰á¾áŸá¶áš 'á€á¶ášá‘á·á‰á”ášá¶á‡áŸá™' á‘áŸ…á€á¶á“áŸ‹: ${gmail}?`,
        icon: '<i class="fas fa-exclamation-triangle"></i>',
        showInput: false,
        confirmText: "á•áŸ’á‰á¾áŸá¶ášá”ášá¶á‡áŸá™",
        color: "#f39c12"
    });

    if (confirmAction) {
        const subject = "á€á¶ášá‘á·á‰ášá”áŸáŸ‹á¢áŸ’á“á€á”á¶á“á”ášá¶á‡áŸá™ âŒ";
        const msg = `á€á¶ášá‘á·á‰ášá”áŸáŸ‹á¢áŸ’á“á€á”á¶á“á”ášá¶á‡áŸá™ âŒ\n\náŸá¼á˜á‡á˜áŸ’ášá¶á”á‡á¼á“,\nâ€¢ á€á¶ášá”á‰áŸ’á‡á¶á‘á·á‰ášá”áŸáŸ‹á¢áŸ’á“á€ááŸ’ášá¼áœá”á¶á“á”áŠá·áŸáŸá’ áŠáŸ„á™áŸá¶ášá˜á·á“á˜á¶á“á€á¶ášá”á„áŸ‹á”áŸ’ášá¶á€áŸ‹ááŸ’ášá¹á˜ááŸ’ášá¼áœáŸ”\n\náŸá¼á˜á–áŸ’á™á¶á™á¶á˜á˜áŸ’áŠá„á‘áŸ€á á¬á‘á¶á€áŸ‹á‘á„á˜á€á€á¶á“áŸ‹á™á¾á„ááŸ’á‰á»áŸ† á”áŸ’ášáŸá·á“á”á¾á˜á¶á“á”á‰áŸ’á á¶!`;
        await postResponse(id, gmail, msg, subject);
    }
}

// --- á˜á»áá„á¶ášá•áŸ’á‰á¾ Email á‘áŸ…á€á¶á“áŸ‹ Backend ---
async function postResponse(id, gmail, message, subject) {
    try {
        const res = await fetch(`${API}/admin/send-response`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, gmail, message, subject })
        });
        if (res.ok) {
            alert("á¢áŸŠá¸á˜áŸ‚á›ááŸ’ášá¼áœá”á¶á“á•áŸ’á‰á¾á‡áŸ„á‚á‡áŸá™!");
            fetchOrders();
        } else {
            alert("á€á¶ášá•áŸ’á‰á¾á¢áŸŠá¸á˜áŸ‚á›á˜á¶á“á”á‰áŸ’á á¶!");
        }
    } catch (error) {
        alert("á˜á·á“á¢á¶á…á—áŸ’á‡á¶á”áŸ‹á‘áŸ…á€á¶á“áŸ‹ Server á”á¶á“á‘áŸ!");
    }
}

// --- á˜á»áá„á¶ášá€áŸ‚á”áŸ’ášáŸ‚á‘á·á“áŸ’á“á“áŸá™ ---
async function editOrder(id, oldGmail, oldSkin, oldAmount) {
    const gmail = prompt("á€áŸ‚á”áŸ’ášáŸ‚ Gmail:", oldGmail);
    if (gmail === null) return; // á…á»á… Cancel
    
    const skin = prompt("á€áŸ‚á”áŸ’ášáŸ‚ Skin:", oldSkin);
    if (skin === null) return;
    
    const amt = prompt("á€áŸ‚á”áŸ’ášáŸ‚ áá˜áŸ’á›áŸƒ:", oldAmount);
    if (amt === null) return;

    if (!gmail || !skin || !amt) {
        alert("áŸá¼á˜á”á‰áŸ’á…á¼á›á–áŸááŸŒá˜á¶á“á±áŸ’á™á”á¶á“á‚áŸ’ášá”áŸ‹á‚áŸ’ášá¶á“áŸ‹!");
        return;
    }

    try {
        const res = await fetch(`${API}/admin/edit-order`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, gmail, skin_name: skin, amount: amt })
        });
        if (res.ok) fetchOrders();
    } catch (error) {
        alert("á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá€áŸ‚á”áŸ’ášáŸ‚!");
    }
}

// --- á˜á»áá„á¶ášá›á»á”á‘á·á“áŸ’á“á“áŸá™ ---
async function deleteOrder(id) {
    const confirmAction = await showModal({
        title: "á›á»á”á‘á·á“áŸ’á“á“áŸá™",
        body: "áá¾á¢áŸ’á“á€á–á·áá‡á¶á…áŸ’á”á¶áŸáŸ‹á‘áŸáá¶á“á¹á„á›á»á”á€á¶ášá”á‰áŸ’á‡á¶á‘á·á‰á“áŸáŸ‡á…áŸá‰á–á¸á”áŸ’ášá–áŸá“áŸ’á’?",
        icon: '<i class="fas fa-trash-alt"></i>',
        showInput: false,
        confirmText: "á›á»á”á¥á¡á¼áœá“áŸáŸ‡",
        color: "#e74c3c"
    });

    if (confirmAction) {
        try {
            const res = await fetch(`${API}/admin/delete-order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            if (res.ok) fetchOrders();
        } catch (error) {
            alert("á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá›á»á”!");
        }
    }
}

// á…á¶á”áŸ‹á•áŸ’áŠá¾á˜áŠáŸ†áá¾ášá€á¶ášáŠáŸ†á”á¼á„
fetchOrders();

// á’áŸ’áœá¾á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–ášáŸ€á„ášá¶á›áŸ‹ áŸ£áŸ  áœá·á“á¶á‘á¸
setInterval(fetchOrders, 30000);
</script>

</body>
</html>